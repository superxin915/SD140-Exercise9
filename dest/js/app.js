mapboxgl.accessToken="pk.eyJ1Ijoic3VwZXJ4aW4iLCJhIjoiY2thNWlqZHd4MDBpODNnb3owMDA2Y3dnYiJ9.-zciQf0emsOdjhIjB2uoNA";const geoLocate=new mapboxgl.GeolocateControl,searchForm=document.querySelector("form"),searchResultArea=document.querySelector(".points-of-interest"),map=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v9"});let latitude,longitude,marker,popup;function searchPlaces(e){fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e}.json?proximity=${longitude},${latitude}&types=poi&limit=10&access_token=${mapboxgl.accessToken}`).then(e=>{if(e.ok)return e.json();throw new Error("Fail to retrieve data.")}).then(e=>{updateSearchResults(e.features)})}function updateSearchResults(e){let t="";e.forEach(e=>{e.distance=calculateDistance(longitude,latitude,e.center[0],e.center[1])}),(e=e.sort((e,t)=>e.distance-t.distance)).forEach(e=>{t+=`\n      <li class="poi" data-long="${e.center[0]}" data-lat="${e.center[1]}">\n        <ul>\n          <li class="name">${e.text}</li>\n          <li class="street-address">${e.properties.address}</li>\n          <li class="distance">${e.distance.toFixed(1)} km</li>\n        </ul>\n      </li>\n    `}),searchResultArea.innerHTML=t}function calculateDistance(e,t,a,o){const n=t*Math.PI/180,s=o*Math.PI/180,r=(o-t)*Math.PI/180,c=(a-e)*Math.PI/180,l=Math.sin(r/2)*Math.sin(r/2)+Math.cos(n)*Math.cos(s)*Math.sin(c/2)*Math.sin(c/2);return 6371e3*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))/1e3}searchForm.addEventListener("submit",e=>{const t=document.querySelector("input");""!==t.value.trim()&&searchPlaces(t.value),t.value="",e.preventDefault()}),searchResultArea.addEventListener("click",e=>{const t=e.target.closest(".poi"),a=+t.dataset.long,o=+t.dataset.lat,n=t.querySelector(".name");void 0!==marker&&marker.remove(),void 0!==popup&&popup.remove(),map.flyTo({center:[a,o],essential:!0}),marker=(new mapboxgl.Marker).setLngLat([a,o]).addTo(map),popup=new mapboxgl.Popup({offset:{bottom:[0,-40]},closeButton:!1}).setLngLat([a,o]).setHTML(`<div>${n.innerText}</div>`).addTo(map)}),map.addControl(geoLocate),map.on("load",()=>{geoLocate.trigger()}),geoLocate.on("geolocate",e=>{latitude=e.coords.latitude,longitude=e.coords.longitude});